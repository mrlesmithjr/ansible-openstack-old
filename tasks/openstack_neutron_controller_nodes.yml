---
- name: openstack_neutron_controller_nodes | Creating Neutron DB
  mysql_db:
    name: "neutron"
    state: "present"
  when: mysql_master

- name: openstack_neutron_controller_nodes | Creating Neutron DB
  mysql_db:
    name: "neutron"
    state: "present"
  when: not mysql_master

- name: openstack_neutron_controller_nodes | Granting Permissions To Nova DB
  mysql_user:
    name: "neutron"
    password: "{{ openstack_neutron_dbpass }}"
    priv: "neutron.*:ALL"
    host: "{{ item }}"
    state: "present"
  with_items:
    - 'localhost'
    - '%'
  when: mysql_master

- name: openstack_neutron_controller_nodes | Granting Permissions To Nova DB
  mysql_user:
    name: "neutron"
    password: "{{ openstack_neutron_dbpass }}"
    priv: "neutron.*:ALL"
    host: "{{ item }}"
    state: "present"
  with_items:
    - 'localhost'
    - '%'
  when: not mysql_master

- name: openstack_neutron_controller_nodes | Installing Neutron Packages
  apt:
    name: "{{ item }}"
    state: "present"
  with_items:
    - 'conntrack'
    - 'neutron-server'
    - 'neutron-plugin-ml2'
    - 'neutron-plugin-linuxbridge-agent'
    - 'neutron-dhcp-agent'
    - 'neutron-metadata-agent'
    - 'python-neutronclient'

- name: openstack_neutron_controller_nodes | Configuring Neutron
  template:
    src: "etc/neutron/neutron.conf.j2"
    dest: "/etc/neutron/neutron.conf"
    owner: "root"
    group: "root"
    mode: 0644
  notify:
    - "restart neutron-server"

- name: openstack_neutron_controller_nodes | Configuring Neutron ML2 Plugin(s)
  template:
    src: "etc/neutron/plugins/ml2/ml2_conf.ini.j2"
    dest: "/etc/neutron/plugins/ml2/ml2_conf.ini"
    owner: "root"
    group: "root"
    mode: 0644
  notify:
    - "restart neutron-server"

- name: openstack_neutron_controller_nodes | Configuring Neutron ML2 Plugin(s)
  template:
    src: "etc/neutron/plugins/ml2/linuxbridge_agent.ini.j2"
    dest: "/etc/neutron/plugins/ml2/linuxbridge_agent.ini"
    owner: "root"
    group: "root"
    mode: 0644
  notify:
    - "restart neutron-plugin-linuxbridge-agent"

- name: openstack_neutron_controller_nodes | Checking If Neutron Has Been Populated
  stat:
    path: "/etc/neutron/neutron_populated"
  register: "neutron_is_populated"
  always_run: yes

- name: openstack_neutron_controller_nodes | Populating Neutron
  command: su -s /bin/sh -c "neutron-db-manage --config-file /etc/neutron/neutron.conf --config-file /etc/neutron/plugins/ml2/ml2_conf.ini upgrade head" neutron
  register: "neutron_populated"
  when: >
        not neutron_is_populated.stat.exists and
        mysql_master

- name: openstack_neutron_controller_nodes | Marking Neutron As Populated
  file:
    path: "/etc/neutron/neutron_populated"
    state: "touch"
  when: neutron_populated.changed
